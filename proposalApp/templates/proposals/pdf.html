{% load static %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="{% static 'css/proposal-pdf.css' %}">
    <link rel="shortcut icon" href="{% static brand.favicon %}">
    <title>{{ proposal.title }} — {{ proposal.company.name }}</title>
    <style>
      /* --- Page setup --- */
      @page {
        size: A4;
        margin: 10mm 18mm 18mm 18mm;
        @bottom-center {
          content: "Page " counter(page) " of " counter(pages);
          font-size: 10px;
          color: #777;
        }
      }
    </style>
  </head>
  <body>

    <!-- Header -->
    <header>
        <img src="{% static brand.logo_static %}" alt="{{ brand.name }} logo">
        <div class="muted">
            <p>{% if brand.website %}{{ brand.website }}{% endif %}</p>
            <p>{% if brand.email %}{{ brand.email }}{% endif %}</p>
            <p>{% if brand.phone %}{{ brand.phone }}{% endif %}</p>
            <p><b>Created:</b> {{ proposal.created_at|date:"Y-m-d" }}</p>
            <p><b>Amounts in:</b> {{ proposal.currency }}</p>
        </div>
    </header>

    <!-- Title -->
    <div class="titlebar">
      <h1>{{ proposal.title }}</h1>
      <small class="muted">Proposal for {{ proposal.company.name }}</small>
    </div>

    <!-- Contact & Summary -->
    <div class="grid-2">
      <div class="box">
        <h2>Client Contact</h2>
        <table class="meta">
          <tr><td>Primary Contact</td><td>{{ proposal.contact_name|default:"—" }}</td></tr>
          <tr><td>Email</td><td>{{ proposal.contact_email|default:"—" }}</td></tr>
          <tr><td>Company Email</td><td>{{ proposal.company.primary_email|default:"—" }}</td></tr>
          <tr><td>Company Phone</td><td>{{ proposal.company.phone|default:"—" }}</td></tr>
        </table>
      </div>
      <div class="box">
        <h2>Totals Summary</h2>
        <table class="meta">
          <tr><td>Subtotal</td><td class="right">${{ proposal.amount_subtotal|floatformat:2 }}</td></tr>
          <tr><td>Discounts</td><td class="right">-${{ proposal.discount_total|floatformat:2 }}</td></tr>
          <tr><td>Tax</td><td class="right">${{ proposal.amount_tax|floatformat:2 }}</td></tr>
          <tr><td><b>Total</b></td><td class="right"><b>${{ proposal.amount_total|floatformat:2 }}</b></td></tr>
          {% if proposal.deposit_amount and proposal.deposit_amount|floatformat != "0.00" %}
          <tr><td>Deposit Due</td><td class="right">${{ proposal.deposit_amount|floatformat:2 }}</td></tr>
          <tr><td>Remaining</td><td class="right">${{ proposal.remaining_due|floatformat:2 }}</td></tr>
          {% endif %}
        </table>
      </div>
    </div>

    <!-- Line items -->
    <h2>Line Items</h2>
    <table class="items">
      <thead>
        <tr class="item_header">
          <th style="width:60%;">Item</th>
          <th style="width:15%;">Quantity</th>
          <th style="width:25%;">Line Total</th>
        </tr>
      </thead>
      <tbody>
        {% for li in items %}
          <tr>
            <td>
              <strong>{{ li.name }}</strong><br>
              <small class="muted">{{ li.description }}</small>
            </td>
            <td class="num">{{ li.quantity|floatformat:2 }}</td>
            <td class="num">${{ li.subtotal|floatformat:2 }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="center muted">No items.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Applied discounts (snapshot) -->
    {% with discounts=proposal.applied_discounts.all %}
      {% if discounts %}
        <h2>Applied Discounts</h2>
        <table>
          <thead>
            <tr>
              <th style="width:40%;">Name</th>
              <th style="width:20%;">Code</th>
              <th style="width:20%;">Type</th>
              <th style="width:20%;">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for d in discounts %}
              <tr>
                <td>{{ d.name }}</td>
                <td>{{ d.discount_code }}</td>
                <td>{{ d.kind }}</td>
                <td class="num">-${{ d.amount_applied|floatformat:2 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endwith %}

    <!-- Totals (explicit footer block) -->
    <div class="totals">
      <table>
        <tbody>
          <tr>
            <td style="width:70%; border:none;"></td>
            <td style="width:30%; border:none;">
              <table>
                <tr><td>Subtotal</td><td class="num">${{ proposal.amount_subtotal|floatformat:2 }}</td></tr>
                <tr><td>Discounts</td><td class="num">-${{ proposal.discount_total|floatformat:2 }}</td></tr>
                <tr><td>Tax</td><td class="num">${{ proposal.amount_tax|floatformat:2 }}</td></tr>
                <tr><td><b>Total</b></td><td class="num"><b>${{ proposal.amount_total|floatformat:2 }}</b></td></tr>
                {% if proposal.deposit_amount and proposal.deposit_amount|floatformat != "0.00" %}
                <tr><td>Deposit Due</td><td class="num">${{ proposal.deposit_amount|floatformat:2 }}</td></tr>
                <tr><td>Remaining</td><td class="num">${{ proposal.remaining_due|floatformat:2 }}</td></tr>
                {% endif %}
              </table>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Notes / terms (optional) -->
    <div class="note">
      <strong>Notes:</strong>
      <div>
        This proposal summarizes the scope discussed and the pricing. Deposit (if any) is due upon acceptance. After signature you will be prompted to create a account which will also generate the invoice for the deposit (if any).
        Work begins after countersignature and receipt of the deposit. All amounts are in {{ proposal.currency }}.
      </div>
    </div>

    <!-- Signature placeholders (optional) -->
    <div class="sign-row">
      <div class="sig-box">
        <div class="sig-label">Client Signature</div>
        <div class="muted">{{ proposal.contact_name|default:"—" }}{% if proposal.contact_email %} — {{ proposal.contact_email }}{% endif %}</div>
      </div>
      <div class="sig-box">
        <div class="sig-label">BeeDev Services (Countersign)</div>
        <div class="muted">
          {% if proposal.approver_user %}
            {{ proposal.approver_user.get_full_name|default:proposal.approver_user.username }}
          {% else %}
            —
          {% endif %}
        </div>
      </div>
    </div>

  </body>
</html>
